<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>汎用コスト計算（安全版）</title>
<style>
body { font-family:sans-serif; background:#f0f0f0; text-align:center; padding:30px; touch-action: manipulation; }
.calculator { max-width:420px; margin:0 auto; }
.sectionA { background:#e3f2fd; border-radius:8px; padding:10px; margin-bottom:15px; display:flex; flex-direction:column; gap:8px; }
.input-group { display:flex; align-items:center; gap:15px; }
.input-group label { flex:0 0 100px; text-align:left; font-weight:bold; color:#1565c0; }
.input-container input { width:100%; border:2px solid #90caf9; border-radius:4px; padding:6px; font-size:17px; text-align:right; background:#fff; }
button { padding:10px 20px; font-size:16px; cursor:pointer; margin-top:15px; }
#result { margin-top:20px; font-size:18px; color:#333; text-align:left; }
.resultA { color:#1565c0; }
.formula-note { font-style:italic; font-size:14px; color:#777; margin-top:4px; text-align:left; }

/* 電卓ポップアップ */
#floatingCalc { display:none; position:absolute; z-index:1000; background:#fff; padding:20px; border-radius:10px; max-width:360px; max-height:500px; font-weight:600; }
#calcDisplay { font-size:22px; font-weight:bold; text-align:right; margin-bottom:0px; min-width:120px; }
#calcButtons { display:grid; grid-template-columns:repeat(4,1fr); gap:6px 10px; }
#calcButtons button { height:40px; font-size:20px; font-weight:bold; border:none; border-radius:4px; background:#e3f2fd; color:#1565c0; cursor:pointer; }
#calcApply { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-top:8px; width:100%; }
#calcApply button { height:40px; font-size:20px; border:none; border-radius:4px; background:#e3f2fd; color:#1565c0; cursor:pointer; display:flex; justify-content:center; align-items:center; }
#calcApply > button#apply { grid-column:3 / span 2; background:#ff9800; color:#fff; }

#calculate-btn { font-size:20px; padding:12px 30px; background:#ff5722; color:#fff; border:none; border-radius:8px; cursor:pointer; transition:0.3s; }
#calculate-btn:hover { background:#f4511e; }

#toast { visibility:hidden; min-width:160px; background:#323232; color:#fff; text-align:center; border-radius:8px; padding:10px; position:fixed; z-index:2000; left:50%; bottom:40px; transform:translateX(-50%); font-size:16px; opacity:0; transition:0.4s; }
#toast.show { visibility:visible; opacity:0.95; bottom:60px; }

</style>
</head>
<body>
<div class="calculator">
<h2>汎用コスト計算</h2>
<div class="sectionA">
  <div class="input-group">
    <label for="nameA">商品名</label>
    <div class="input-container"><input type="text" id="nameA" placeholder="任意"></div>
  </div>
  <div class="input-group">
    <label for="priceA">価　格</label>
    <div class="input-container"><input type="number" id="priceA"></div>
  </div>
  <div class="input-group">
    <label for="volumeA">本体量</label>
    <div class="input-container"><input type="number" id="volumeA"></div>
  </div>
  <div class="input-group">
    <label for="usageA">使用量</label>
    <div class="input-container"><input type="number" id="usageA" value="1"></div>
  </div>
</div>
<button id="calculate-btn">計算する</button>
<div id="result"></div>
</div>

<div id="floatingCalc">
  <div id="calcDisplay">0</div>
  <div id="calcButtons">
    <button>７</button><button>８</button><button>９</button><button>÷</button>
    <button>４</button><button>５</button><button>６</button><button>×</button>
    <button>１</button><button>２</button><button>３</button><button>－</button>
    <button>０</button><button>.</button><button>C</button><button>＋</button>
  </div>
  <div id="calcApply">
    <button id="equals">=</button><div class="spacer"></div><button id="apply">入力</button>
  </div>
</div>

<div id="toast">コピーしました</div>

<script>
let calcExpression=''; let calcResult=null; let calcEvaluated=false; let activeInput=null;

function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(t._hideTimer); t._hideTimer=setTimeout(()=>t.classList.remove('show'),2000); }
function temporarilyDisableAllButtons(ms){ document.querySelectorAll('button').forEach(b=>b.disabled=true); setTimeout(()=>document.querySelectorAll('button').forEach(b=>b.disabled=false), ms||200); }
function normalizeExpression(expr){ return expr.replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/×/g,'*').replace(/÷/g,'/').replace(/－/g,'-').replace(/＋/g,'+').replace(/，/g,',').replace(/．/g,'.'); }

function showCalculator(input){
    if(!input) return; activeInput=input; calcExpression=''; calcResult=null; calcEvaluated=false; document.getElementById('calcDisplay').textContent='0';
    const calc=document.getElementById('floatingCalc'); calc.style.display='block';
    const rect=input.closest('.input-group').getBoundingClientRect();
    const scrollY=window.scrollY||document.documentElement.scrollTop;
    const scrollX=window.scrollX||document.documentElement.scrollLeft;
    calc.style.top=scrollY+rect.bottom+5+'px';
    calc.style.left=scrollX+rect.left+(rect.width-calc.offsetWidth)/2+'px';
}

function press(val){ if(calcEvaluated){ calcExpression=''; calcEvaluated=false; } calcExpression+=val; document.getElementById('calcDisplay').textContent=calcExpression; }
function clearCalc(){ calcExpression=''; calcResult=null; calcEvaluated=false; document.getElementById('calcDisplay').textContent='0'; if(activeInput) activeInput.value=''; }
function calculateExpression(){ try{ const res=eval(normalizeExpression(calcExpression)); calcResult=res; document.getElementById('calcDisplay').textContent=calcExpression+' = '+res; calcEvaluated=true; }catch(e){ document.getElementById('calcDisplay').textContent='式エラー'; calcEvaluated=false; } }
function applyToInput(){
    temporarilyDisableAllButtons(500);
    if(!activeInput) return;
    if(!calcExpression.trim()){ document.getElementById('floatingCalc').style.display='none'; activeInput=null; return; }
    if(!calcEvaluated) calculateExpression();
    if(calcEvaluated && !isNaN(calcResult)) activeInput.value=calcResult;
    document.getElementById('floatingCalc').style.display='none'; activeInput=null;
}


// 商品名入力後に Enter キーで価格欄に移動して電卓を表示
document.getElementById('nameA').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault();

        const nextInput = document.getElementById('priceA');
        if (!nextInput) return;

        // 次の入力欄にフォーカスは当てずに電卓だけ表示
        if (typeof showCalculator === 'function') {
            showCalculator(nextInput);
        }
    }
});
  


  
document.querySelectorAll('.sectionA input[type=number]').forEach(input=>{ input.addEventListener('pointerdown',()=>showCalculator(input)); });
document.querySelectorAll('#calcButtons button').forEach(b=>b.addEventListener('click',()=>{ const v=b.textContent; v==='C'?clearCalc():press(v); }));
document.getElementById('equals').addEventListener('click',calculateExpression);
document.getElementById('apply').addEventListener('click',applyToInput);
document.getElementById('calculate-btn').addEventListener('click',()=>{
    const nameA=document.getElementById('nameA').value||'商品A';
    const vA=parseFloat(document.getElementById('volumeA').value);
    const uA=parseFloat(document.getElementById('usageA').value);
    const pA=parseFloat(document.getElementById('priceA').value);
    let output='', logText='';
    if(vA>0 && uA>0 && !isNaN(pA) && !isNaN(vA) && !isNaN(uA)){
        const cost=pA*(uA/vA); output=`<div class="resultA"><strong>${nameA}</strong><br>1回のコスト：${cost.toFixed(2)} 円</div>`;
        logText=`${nameA}: ${pA} ÷ ${vA} × ${uA} = ${cost.toFixed(2)} 円`;
    } else { output=`<div class="resultA">${nameA}の入力が不完全です</div>`; logText=`${nameA}の入力が不完全です`; }
    document.getElementById('result').innerHTML=output;
});
</script>
</body>
</html>

