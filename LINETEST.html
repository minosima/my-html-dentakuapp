<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>汎用コスト計算</title>
<style>
    body { font-family:sans-serif; background:#f0f0f0; padding:30px; text-align:center; touch-action:manipulation; }
    .calculator { width:100%; max-width:420px; margin:0 auto; }
    .sectionA { background:#e3f2fd; border-radius:8px; padding:10px; margin-bottom:15px; display:flex; flex-direction:column; gap:8px; }
    .input-group { display:flex; align-items:center; gap:10px; }
    .label-with-clear { display:flex; align-items:center; gap:6px; flex:0 0 100px; }
    .label-with-clear label { color:#1565c0; font-weight:bold; font-size:17px; }
    .clear-btn { background:#ffebee; color:#c62828; border:1px solid #ffcdd2; border-radius:4px; font-weight:bold; font-size:17px; padding:6px 12px; cursor:pointer; transition:background 0.2s; }
    .clear-btn:hover { background:#ffcdd2; }
    .input-container { flex:1; display:flex; flex-direction:column; gap:4px; }
    .input-container input { width:100%; border:2px solid #90caf9; background:#fff; padding:6px; border-radius:4px; font-size:17px; text-align:right; }
    button { padding:10px 20px; font-size:16px; margin-top:15px; cursor:pointer; }
    #calculate-btn { font-size:20px; padding:12px 30px; background:#ff5722; color:#fff; border:none; border-radius:8px; }
    #result { margin-top:20px; font-size:18px; color:#333; text-align:left; }
    .resultA { color:#1565c0; }
    #logContainer { max-width:420px; margin:20px auto 0; text-align:left; display:none; }
    #logHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    #calcLog { list-style:none; padding:0; margin:0; }
    #calcLog li { background:#fff; border:1px solid #ccc; border-radius:4px; padding:8px; margin-bottom:6px; display:flex; align-items:center; justify-content:space-between; }
    .logText { flex:1; margin-right:8px; word-break:break-all; }
    .logBtn { font-size:14px; font-weight:bold; padding:4px 8px; border:none; border-radius:4px; margin-left:4px; cursor:pointer; }
    .logBtn.copy { background:#e3f2fd; color:#1565c0; }
    .logBtn.delete { background:#ffebee; color:#c62828; }
    .formula-note { font-style:italic; font-size:14px; color:#777; margin-top:4px; text-align:left; }
    #floatingCalc { display:none; position:absolute; z-index:1000; background:#fff; padding:20px; max-width:360px; max-height:500px; border-radius:10px; font-weight:600; border-top:1px solid #fff; border-left:18px solid #fff; border-right:18px solid #fff; border-bottom:64px solid #fff; transform-origin:top center; }
    #calcDisplay { font-size:22px; font-weight:bold; margin-bottom:0; text-align:right; min-width:120px; }
    #calcButtons { display:grid; grid-template-columns:repeat(4,1fr); column-gap:10px; row-gap:6px; }
    #calcButtons button, #calcApply button { height:40px; font-size:20px; font-weight:bold; background:#e3f2fd; border:none; border-radius:4px; color:#1565c0; cursor:pointer; display:flex; justify-content:center; align-items:center; }
    #calcApply { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-top:8px; width:100%; }
    #calcApply > button#apply { grid-column:3/span 2; background:#ff9800; color:#fff; }
    #customConfirmModal { display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); }
    #customConfirmModal > div { background:#fefefe; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:300px; border-radius:8px; }
    #customConfirmModal p { font-size:16px; font-weight:bold; }
    #customConfirmModal button { padding:8px 16px; }
    #toast { visibility:hidden; min-width:160px; background:#323232; color:#fff; text-align:center; border-radius:8px; padding:10px; position:fixed; z-index:2000; left:50%; bottom:40px; transform:translateX(-50%); font-size:16px; opacity:0; transition: opacity 0.4s, bottom 0.4s; }
    #toast.show { visibility:visible; opacity:0.95; bottom:60px; }
    .restore-btn { background:#00bcd4; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; display:inline-block; margin-top:4px; }
    .restore-btn:hover { background:#0097a7; }
</style>
</head>
<body>
<div class="calculator">
    <h2>汎用コスト計算</h2>
    <div class="sectionA">
        <div class="input-group">
            <div class="label-with-clear">
                <label for="nameA">商品名</label>
                <button id="clearName" type="button" class="clear-btn">Ｃ</button>
            </div>
            <div class="input-container"><input type="text" id="nameA" placeholder="任意"></div>
        </div>
        <div class="input-group">
            <div class="label-with-clear"><label for="priceA">価　格</label><button class="clear-btn" style="visibility:hidden;"></button></div>
            <div class="input-container"><input type="number" id="priceA"></div>
        </div>
        <div class="input-group">
            <div class="label-with-clear"><label for="volumeA">本体量</label><button class="clear-btn" style="visibility:hidden;"></button></div>
            <div class="input-container"><input type="number" id="volumeA"></div>
        </div>
        <div class="input-group">
            <div class="label-with-clear"><label for="usageA">使用量</label><button class="clear-btn" style="visibility:hidden;"></button></div>
            <div class="input-container"><input type="number" id="usageA" value="1"></div>
        </div>
    </div>
    <button id="calculate-btn">計算する</button>
    <div id="result"></div>
</div>

<button onclick="downloadBackup()">バックアップ保存</button>
<label class="restore-btn">
    <input type="file" accept="application/json" style="display:none" onchange="restoreBackup(event)">
    バックアップ復元
</label>

<div id="logContainer">
    <div id="logHeader">
        <h3>計算ログ</h3>
        <div id="logActions">
            <button id="copyAllLogs" class="logBtn copy">全コピー</button>
            <button id="clearAllLogs" class="logBtn delete" type="button">全クリア</button>
        </div>
    </div>
    <ul id="calcLog"></ul>
</div>

<div id="customConfirmModal">
    <div>
        <p>計算ログをすべてクリアしますか？</p>
        <div style="display:flex; justify-content:space-around; margin-top:20px;">
            <button id="confirmYes" class="logBtn delete">はい</button>
            <button id="confirmNo" class="logBtn copy">いいえ</button>
        </div>
    </div>
</div>

<div id="toast" aria-live="polite" role="status">コピーしました</div>

<script>
/* -----------------------------
   共通関数
----------------------------- */
function showToast(msg,bg='#333',tc='#fff'){const t=document.getElementById('toast'); t.textContent=msg; t.style.background=bg; t.style.color=tc; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000);}
function copyTextToClipboard(text){if(!text||!text.trim()){showToast('ログがありません'); return;} navigator.clipboard?.writeText(text).then(()=>showToast('コピーしました','#1565c0','#fff')).catch(()=>showToast('コピー失敗','#ff5252','#fff'));}

/* -----------------------------
   ログ管理
----------------------------- */
function addLog(text){
    const logList=document.getElementById('calcLog'); document.getElementById('logContainer').style.display='block';
    const li=document.createElement('li'); const span=document.createElement('span'); span.className='logText'; span.textContent=text;
    const copyBtn=document.createElement('button'); copyBtn.className='logBtn copy'; copyBtn.textContent='コピー'; copyBtn.addEventListener('click',()=>copyTextToClipboard(span.textContent));
    const delBtn=document.createElement('button'); delBtn.className='logBtn delete'; delBtn.textContent='削除'; delBtn.addEventListener('click',()=>{li.remove(); showToast("削除しました","red"); if(logList.querySelectorAll('li').length===0) document.getElementById('logContainer').style.display='none';});
    li.append(span,copyBtn,delBtn); logList.insertBefore(li, logList.firstChild);
}

/* -----------------------------
   計算
----------------------------- */
function calculate(){
    const name=document.getElementById('nameA').value.trim()||'商品A';
    const v=parseFloat(document.getElementById('volumeA').value);
    const u=parseFloat(document.getElementById('usageA').value);
    const p=parseFloat(document.getElementById('priceA').value);
    let output='', logText='';
    if(v>0 && u>0 && p>=0 && !isNaN(v)&&!isNaN(u)&&!isNaN(p)){
        const cost=p*(u/v);
        output=`<div class="resultA"><strong>${name}</strong><br>1回のコスト：${cost.toFixed(2)} 円</div>`;
        logText=`${name}: ${p} ÷ ${v} × ${u} = ${cost.toFixed(2)} 円`;
    } else { output=`<div class="resultA">${name}の入力が不完全です</div>`; logText=`${name}の入力が不完全です`; }
    document.getElementById('result').innerHTML=output;
    addLog(logText);
    showToast("計算しました",'#ff5722');
}

/* -----------------------------
   バックアップ保存・復元
----------------------------- */
const STORAGE_KEY="calcLogsBackup";
function saveLogsToLocalStorage(){const logs=Array.from(document.querySelectorAll('#calcLog .logText')).map(el=>el.textContent); localStorage.setItem(STORAGE_KEY,JSON.stringify(logs));}
function loadLogsFromLocalStorage(){const saved=localStorage.getItem(STORAGE_KEY); if(!saved) return; JSON.parse(saved).forEach(text=>addLog(text));}
function downloadBackup(){const logs=localStorage.getItem(STORAGE_KEY); if(!logs){showToast("保存されたログがありません","#ff5252"); return;} const blob=new Blob([logs],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="calcLogsBackup.json"; a.click(); showToast("バックアップをダウンロードしました","#00c853");}
function restoreBackup(event){const file=event.target.files[0]; if(!file){showToast("ファイルが選択されていません","#ff5252"); return;} const reader=new FileReader(); reader.onload=(e)=>{try{const logs=JSON.parse(e.target.result); if(!Array.isArray(logs)) throw new Error("形式が不正"); document.getElementById("calcLog").innerHTML=""; logs.forEach(text=>addLog(text)); localStorage.setItem(STORAGE_KEY,JSON.stringify(logs)); showToast("バックアップを復元しました","#00c853");}catch{showToast("復元に失敗しました","#ff5252");}}; reader.readAsText(file);}
window.addEventListener('DOMContentLoaded',loadLogsFromLocalStorage);

/* -----------------------------
   入力フォーカス移動
----------------------------- */
function moveToNextInput(currentInput){
    const inputs=Array.from(document.querySelectorAll(".sectionA input"));
    const idx=inputs.indexOf(currentInput);
    if(idx>-1 && idx<inputs.length-1){inputs[idx+1].focus();}
}

document.getElementById('calculate-btn').addEventListener('click',calculate);
document.getElementById('nameA').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); moveToNextInput(e.target);}});

/* -----------------------------
   商品名クリア
----------------------------- */
document.getElementById('clearName').addEventListener('click',()=>{const nameInput=document.getElementById('nameA'); nameInput.value=''; nameInput.focus(); showToast('商品名をクリアしました','#c62828');});

/* -----------------------------
   電卓（number input用）
----------------------------- */
let activeInput=null, calcExpression='', calcEvaluated=false, calcResult=null;
function normalizeExpression(expr){return expr.replace(/×/g,'*').replace(/÷/g,'/').replace(/－/g,'-').replace(/＋/g,'+');}
function press(val){if(calcEvaluated){calcExpression=''; calcEvaluated=false;} calcExpression+=val; document.getElementById("calcDisplay").textContent=calcExpression;}
function clearCalc(){calcExpression=''; calcEvaluated=false; calcResult=null; document.getElementById("calcDisplay").textContent='0';}
function calculateExpression(){try{calcResult=eval(normalizeExpression(calcExpression)); document.getElementById("calcDisplay").textContent=`${calcExpression} = ${calcResult}`; calcEvaluated=true;}catch{document.getElementById("calcDisplay").textContent='式エラー'; calcEvaluated=false;}}
function applyToInput(){if(!activeInput) return; if(!calcExpression.trim()){document.getElementById("floatingCalc").style.display='none'; moveToNextInput(activeInput); activeInput=null; return;} if(!calcEvaluated) calculateExpression(); if(calcEvaluated && !isNaN(calcResult)) activeInput.value=calcResult; document.getElementById("floatingCalc").style.display='none'; moveToNextInput(activeInput); activeInput=null;}
function showCalculator(input){activeInput=input; calcExpression=''; calcEvaluated=false; calcResult=null; document.getElementById("calcDisplay").textContent='0'; const calc=document.getElementById("floatingCalc"); calc.style.display='block'; const rect=input.getBoundingClientRect(); calc.style.top=window.scrollY+rect.bottom+5+'px'; calc.style.left=window.scrollX+rect.left+(rect.width/2)-(calc.offsetWidth/2)+'px';}
document.querySelectorAll('.sectionA input[type="number"]').forEach(input=>{input.addEventListener('touchstart',e=>{e.preventDefault(); showCalculator(input);}); input.addEventListener('click',e=>{showCalculator(input);});});
document.querySelectorAll('#calcButtons button').forEach(btn=>{btn.addEventListener('click',()=>{const val=btn.textContent; if(val==='C') clearCalc(); else press(val);});});
document.getElementById('equals').addEventListener('click',calculateExpression);
document.getElementById('apply').addEventListener('click',applyToInput);

/* -----------------------------
   全コピー/全削除
----------------------------- */
document.getElementById('copyAllLogs').addEventListener('click',()=>{const logs=Array.from(document.querySelectorAll('#calcLog .logText')).map(sp=>sp.textContent).join('\n'); copyTextToClipboard(logs);});
document.getElementById('clearAllLogs').addEventListener('click',()=>document.getElementById('customConfirmModal').style.display='block');
document.getElementById('confirmNo').addEventListener('click',()=>document.getElementById('customConfirmModal').style.display='none');
document.getElementById('confirmYes').addEventListener('click',()=>{document.getElementById('calcLog').innerHTML=''; document.getElementById('logContainer').style.display='none'; document.getElementById('customConfirmModal').style.display='none'; showToast("削除しました","red");});
</script>
</body>
</html>
